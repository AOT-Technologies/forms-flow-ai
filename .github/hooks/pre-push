#!/bin/sh
set -eu

# Configuration
GIT_DIR="$(git rev-parse --git-dir)"
ENV_FILE="$GIT_DIR/hooks/.env"
HOOK_DIR=".github/hooks"
LOG_FILE="$HOOK_DIR/snyk-scan.log"

# Load environment variables from .env file
if [ -f "$ENV_FILE" ]; then
    export $(grep -v '^#' "$ENV_FILE" | xargs)
fi

# Validate SNYK_TOKEN
if [ -z "${SNYK_TOKEN:-}" ]; then
    echo "âŒ SNYK_TOKEN is missing in $ENV_FILE" > /dev/tty
    echo "âš ï¸  Skipping Snyk scan due to missing token." > /dev/tty
    exit 0
fi

# Ensure log directory exists
mkdir -p "$HOOK_DIR"

# Get latest commit message
LAST_COMMIT_MSG=$(git log -1 --pretty=%B)

# Check if 'skip-snyk' is in the commit message
if echo "$LAST_COMMIT_MSG" | grep -qi "skip-snyk"; then
  echo "âš ï¸  Snyk scan skipped due to 'skip-snyk' flag in commit message."
  exit 0
fi

# Function to detect OS and set Snyk command
setup_snyk_command() {
    if command -v snyk >/dev/null 2>&1; then
        SNYK_CMD="snyk"
    else
        echo "âš ï¸  Snyk CLI not found. Attempting to install..." > /dev/tty

        if command -v npm >/dev/null 2>&1; then
            echo "ðŸ“¦ Installing Snyk CLI via npm..." > /dev/tty
            npm install -g snyk >/dev/null 2>&1
        fi

        if ! command -v snyk >/dev/null 2>&1; then
            echo "â¬‡ï¸  Downloading Snyk CLI binary..." > /dev/tty
            if command -v curl >/dev/null 2>&1; then
                curl -sL https://static.snyk.io/cli/latest/snyk-linux -o /usr/local/bin/snyk
            elif command -v wget >/dev/null 2>&1; then
                wget -qO /usr/local/bin/snyk https://static.snyk.io/cli/latest/snyk-linux
            else
                echo "âŒ Neither curl nor wget is available. Please install Snyk manually." > /dev/tty
                return 1
            fi
            chmod +x /usr/local/bin/snyk
        fi

        if command -v snyk >/dev/null 2>&1; then
            echo "âœ… Snyk CLI installed successfully." > /dev/tty
            SNYK_CMD="snyk"
        else
            echo "âŒ Failed to install Snyk. Please install manually." > /dev/tty
            return 1
        fi
    fi

    echo "ðŸ” Authenticating Snyk with token..." > /dev/tty
    $SNYK_CMD auth "$SNYK_TOKEN" >/dev/null 2>&1
    return $?
}

# Check package-lock consistency
check_prerequisites() {
    echo "ðŸ” Checking prerequisites..." > /dev/tty
    if [ -f "package.json" ] && [ -f "package-lock.json" ]; then
        echo "ðŸ“¦ Checking package.json sync..." > /dev/tty
        if ! npm ls >/dev/null 2>&1; then
            echo "âš ï¸  package.json and package-lock.json might be out of sync." > /dev/tty
            echo "   Consider running 'npm install' to fix." > /dev/tty
        fi
    fi
}

# Run Snyk test and log results
run_snyk_test() {
    echo "ðŸ” Running Snyk vulnerability test..." > /dev/tty
    if "$SNYK_CMD" test --all-projects --severity-threshold=high > "$LOG_FILE" 2>&1; then
        echo "âœ… No high/critical vulnerabilities found." > /dev/tty
    else
        echo "ðŸš¨ Vulnerabilities found! Review log at: $LOG_FILE" > /dev/tty
    fi
}

# Send project to Snyk monitor
run_snyk_monitor() {
    echo "ðŸ“¡ Sending project snapshot to Snyk..." > /dev/tty
    EXCLUDE_PATTERNS="**/node_modules/**,**/vendor/**,**/target/**,**/.git/**"
    if "$SNYK_CMD" monitor --all-projects --detection-depth=2 --exclude="$EXCLUDE_PATTERNS" --skip-unresolved >/dev/null 2>&1; then
        echo "âœ… Project sent to Snyk monitoring." > /dev/tty
    else
        echo "âš ï¸  Snyk monitor failed. Check your project settings." > /dev/tty
    fi
}

# Main execution
echo "ðŸ›¡ï¸  Starting Snyk security scan..." > /dev/tty
if ! setup_snyk_command; then
    echo "âš ï¸  Skipping scan due to Snyk setup failure." > /dev/tty
    exit 0
fi

check_prerequisites || true
run_snyk_test || true
run_snyk_monitor || true

echo "ðŸ“œ Snyk scan log saved to: $LOG_FILE" > /dev/tty
echo "ðŸŽ‰ Security scan completed. Proceeding with push..." > /dev/tty
exit 0
