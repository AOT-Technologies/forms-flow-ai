#!/bin/sh
set -eu

# Configuration
GIT_DIR="$(git rev-parse --git-dir)"
FLAG_FILE="$GIT_DIR/hooks/.skip-snyk"

# Check if user opted out
if [ -f "$FLAG_FILE" ]; then
    choice=$(cat "$FLAG_FILE" 2>/dev/null || echo "")
    rm -f "$FLAG_FILE"
    if [ "$choice" = "skip" ]; then
        echo "âš ï¸  User chose to skip Snyk scan. Proceeding with push..." > /dev/tty
        exit 0
    fi
fi

# Function to detect OS and set Snyk command
setup_snyk_command() {
    if command -v snyk >/dev/null 2>&1; then
        SNYK_CMD="snyk"
        return 0
    fi
    
    # Auto-install logic here (as in previous version)
    echo "âŒ Snyk CLI not found. Please install it first:" > /dev/tty
    echo "   npm install -g snyk" > /dev/tty
    echo "   OR download from: https://github.com/snyk/snyk" > /dev/tty
    return 1
}

# Function to check prerequisites
check_prerequisites() {
    echo "ðŸ” Checking prerequisites..." > /dev/tty
    
    # Check if Maven is available for Java projects
    if find . -name "pom.xml" -type f | head -1 | grep -q .; then
        if ! command -v mvn >/dev/null 2>&1; then
            echo "âš ï¸  Maven not found but pom.xml files detected." > /dev/tty
            echo "   Installing Maven is recommended for complete scanning." > /dev/tty
            echo "   Download from: https://maven.apache.org/download.cgi" > /dev/tty
            return 1
        fi
    fi
    
    # Check for package.json/package-lock.json sync issues
    if [ -f "package.json" ] && [ -f "package-lock.json" ]; then
        echo "ðŸ“¦ Checking package.json sync..." > /dev/tty
        if ! npm ls >/dev/null 2>&1; then
            echo "âš ï¸  package.json and package-lock.json might be out of sync." > /dev/tty
            echo "   Consider running 'npm install' to fix." > /dev/tty
            return 1
        fi
    fi
    
    return 0
}

# Function to run Snyk test with better filtering
run_snyk_test() {
    echo "ðŸ” Running Snyk vulnerability test..." > /dev/tty
    
    # Test only the main project first (most reliable)
    if "$SNYK_CMD" test --severity-threshold=high 2>/dev/null; then
        echo "âœ… No high/critical vulnerabilities found in main project." > /dev/tty
        return 0
    else
        test_exit_code=$?
        case $test_exit_code in
            1)
                echo "ðŸš¨ High or critical vulnerabilities found in main project!" > /dev/tty
                echo "   View details: $SNYK_CMD test" > /dev/tty
                ;;
            2)
                echo "âš ï¸  Snyk test configuration issues detected." > /dev/tty
                ;;
            3)
                echo "â„¹ï¸  No supported projects found for main test." > /dev/tty
                ;;
            *)
                echo "âš ï¸  Snyk test completed with warnings (exit code: $test_exit_code)." > /dev/tty
                ;;
        esac
        return 0  # Don't block push for test issues
    fi
}

# Function to run Snyk monitor with better exclusions
run_snyk_monitor() {
    echo "ðŸ“¡ Sending project snapshot to Snyk (this may take a moment)..." > /dev/tty
    
    # More targeted exclusions to avoid problematic files
    EXCLUDE_PATTERNS="**/node_modules/**,**/vendor/**,**/target/**,**/.git/**,**/scripts/**,**/project.json"
    
    # Try monitor with exclusions first
    if "$SNYK_CMD" monitor \
        --all-projects \
        --detection-depth=2 \
        --exclude="$EXCLUDE_PATTERNS" \
        --skip-unresolved \
        >/dev/null 2>&1; then
        echo "âœ… All projects successfully sent to Snyk for monitoring." > /dev/tty
        return 0
    fi
    
    # If that fails, try a more conservative approach
    echo "âš ï¸  Full monitor failed, trying main project only..." > /dev/tty
    if "$SNYK_CMD" monitor --skip-unresolved >/dev/null 2>&1; then
        echo "âœ… Main project sent to Snyk for monitoring." > /dev/tty
        return 0
    fi
    
    # If still failing, just warn and continue
    echo "âš ï¸  Monitor had issues but continuing. Check dashboard manually:" > /dev/tty
    echo "   https://app.snyk.io/org/alanraju-aot" > /dev/tty
    return 0
}

# Function to provide helpful tips based on detected issues
provide_tips() {
    echo "" > /dev/tty
    echo "ðŸ’¡ Tips for better Snyk scanning:" > /dev/tty
    
    # Check for specific issues and provide targeted advice
    if find . -name "pom.xml" -type f | head -1 | grep -q . && ! command -v mvn >/dev/null 2>&1; then
        echo "   â€¢ Install Maven for Java project scanning" > /dev/tty
    fi
    
    if [ -f "package.json" ] && [ -f "package-lock.json" ]; then
        echo "   â€¢ Keep package.json and package-lock.json in sync with 'npm install'" > /dev/tty
    fi
    
    if find . -name "requirements.txt" -type f | head -1 | grep -q .; then
        echo "   â€¢ Ensure Python virtual environment is activated for Python scanning" > /dev/tty
    fi
    
    echo "   â€¢ Review findings at: https://app.snyk.io/org/alanraju-aot" > /dev/tty
    echo "" > /dev/tty
}

# Main execution
echo "ðŸ›¡ï¸  Starting Snyk security scan..." > /dev/tty

# Setup Snyk command
if ! setup_snyk_command; then
    echo "âš ï¸  Skipping Snyk scan due to setup issues." > /dev/tty
    exit 0
fi

# Check authentication
if ! "$SNYK_CMD" auth --quiet >/dev/null 2>&1; then
    echo "âŒ Snyk not authenticated. Run: $SNYK_CMD auth" > /dev/tty
    echo "âš ï¸  Skipping scan due to authentication failure." > /dev/tty
    exit 0
fi

# Check prerequisites (non-blocking)
check_prerequisites || {
    echo "âš ï¸  Some prerequisites missing but continuing..." > /dev/tty
}

# Run Snyk test (non-blocking)
run_snyk_test

# Run Snyk monitor (non-blocking)
run_snyk_monitor

# Provide helpful tips
provide_tips

echo "ðŸŽ‰ Security scan completed. Push proceeding..." > /dev/tty
exit 0